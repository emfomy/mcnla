////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @file    include/mcnla/isvd/core/parameters.hpp
/// @brief   The the parameter structure of iSVD driver.
///
/// @author  Mu Yang <<emfomy@gmail.com>>
///

#ifndef MCNLA_ISVD_CORE_PARAMETERS_HPP_
#define MCNLA_ISVD_CORE_PARAMETERS_HPP_

#include <mcnla/isvd/core/parameters.hh>

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  The MCNLA namespace.
//
namespace mcnla {

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  The iSVD namespace.
//
namespace isvd {

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @brief  Default constructor
///
Parameters::Parameters(
    const MPI_Comm mpi_comm,
    const mpi_int_t mpi_root,
    const index_t seed
) noexcept
  : mpi_comm(mpi_comm),
    mpi_size(mpi::commSize(mpi_comm)),
    mpi_root(mpi_root),
    mpi_rank(mpi::commRank(mpi_comm)),
    streams_(seed) {}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @brief  Synchronize the parameters
///
void Parameters::sync() noexcept {
  MPI_Bcast(&params_, sizeof(params_), MPI_BYTE, mpi_root, mpi_comm);
  synchronized_ = true;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @brief  Check if the parameters is synchronized.
///
bool Parameters::isSynchronized() const noexcept {
  return synchronized_;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @brief  Gets the number of rows of the matrix.
///
index_t Parameters::nrow() const noexcept {
  return params_.nrow_;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @brief  Gets the number of rows of the matrix per MPI node.
///
index_t Parameters::nrowEach() const noexcept {
  return (params_.nrow_-1) / mpi_size + 1;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @brief  Gets the number of total allocated rows of the matrix.
///
index_t Parameters::nrowTotal() const noexcept {
  return nrowEach() * mpi_size;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @brief  Gets the number of column of the matrix.
///
index_t Parameters::ncol() const noexcept {
  return params_.ncol_;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @brief  Gets the desired rank of approximate SVD.
///
index_t Parameters::rank() const noexcept {
  return params_.rank_;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @brief  Gets the oversampling dimension.
///
index_t Parameters::overRank() const noexcept {
  return params_.over_rank_;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @brief  Gets the dimension of random sketches.
///
index_t Parameters::dimSketch() const noexcept {
  return params_.rank_ + params_.over_rank_;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @brief  Gets the number of random sketches of all MPI nodes.
///
index_t Parameters::numSketch() const noexcept {
  return params_.num_sketch_each_ * mpi_size;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @brief  Gets the number of random sketches per MPI node.
///
index_t Parameters::numSketchEach() const noexcept {
  return params_.num_sketch_each_;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @brief  Gets the random streams.
///
const random::Streams& Parameters::streams() const noexcept {
  return streams_;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @brief  Sets the sizes of the matrix.
///
template <class _Matrix>
Parameters& Parameters::setSize(
    const _Matrix &matrix
) noexcept {
  return setSize(matrix.nrow(), matrix.ncol());
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @copydoc  setSize
///
Parameters& Parameters::setSize(
    const index_t nrow,
    const index_t ncol
) noexcept {
  params_.nrow_ = nrow;
  params_.ncol_ = ncol;
  synchronized_ = false;
  return *this;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @brief  Sets the desired rank of approximate SVD.
///
Parameters& Parameters::setRank(
    const index_t rank
) noexcept {
  params_.rank_ = rank;
  synchronized_ = false;
  return *this;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @brief  Sets the dimension of random sketches.
///
Parameters& Parameters::setOverRank(
    const index_t over_rank
  ) noexcept {
  params_.over_rank_ = over_rank;
  synchronized_ = false;
  return *this;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @brief  Sets the number of total random sketches.
///
/// @attention  @a num_sketch must be a multiple of @ref mcnla::mpi::commSize "mpi_size".
///
Parameters& Parameters::setNumSketch(
    const index_t num_sketch
) noexcept {
  params_.num_sketch_each_ = num_sketch / mpi_rank;
  synchronized_ = false;
  return *this;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @brief  Sets the number of random sketches per MPI node.
///
Parameters& Parameters::setNumSketchEach(
    const index_t num_sketch_each
) noexcept {
  params_.num_sketch_each_ = num_sketch_each;
  synchronized_ = false;
  return *this;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @copydoc  random::Streams::setSeed
///
Parameters& Parameters::setSeed(
    const index_t seed
) noexcept {
  streams_.setSeed(seed);
  return *this;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// @copydoc  random::Streams::setSeeds
///
Parameters& Parameters::setSeeds(
    const index_t seed
) noexcept {
  streams_.setSeeds(seed, mpi_root, mpi_comm);
  return *this;
}

}  // namespace isvd

}  // namespace mcnla

#endif  // MCNLA_ISVD_CORE_PARAMETERS_HPP_
